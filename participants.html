<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>참여자 관리 - 리더십 진단 관리자</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
    }
    .nav-item {
      transition: all 0.3s ease;
    }
    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-item.active {
      background-color: rgba(255, 255, 255, 0.2);
      border-left: 4px solid #fff;
    }
    
    /* 모바일 반응형 */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0 !important;
      }
      .mobile-overlay {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
      }
    }
    
    /* 파일 드래그 앤 드롭 스타일 */
    .file-drop-area {
      border: 2px dashed #cbd5e0;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }
    .file-drop-area.dragover {
      border-color: #3182ce;
      background-color: #ebf8ff;
    }
    
    /* 테이블 스타일 */
    .table-container {
      max-height: 400px;
      overflow-y: auto;
    }
    
    /* 상태 배지 */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
    }
    .status-completed {
      background-color: #d1fae5;
      color: #065f46;
    }
    .status-expired {
      background-color: #fee2e2;
      color: #991b1b;
    }
  </style>
  <script src="auth.js"></script>
</head>
<body class="bg-gray-50">
  
  <!-- Mobile Menu Overlay -->
  <div id="mobileOverlay" class="fixed inset-0 mobile-overlay z-40 hidden md:hidden"></div>
  
  <!-- Navigation Sidebar -->
  <div id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 bg-gray-800 text-white z-50">
    <div class="p-4 md:p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-lg md:text-xl font-bold">관리자 대시보드</h1>
          <p class="text-gray-400 text-xs md:text-sm" id="adminWelcome">관리자님 환영합니다</p>
        </div>
        <button id="closeSidebar" class="md:hidden text-white hover:text-gray-300">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>
    
    <nav class="mt-4 md:mt-8">
      <a href="dashboard.html" class="nav-item flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-tachometer-alt mr-3"></i>
        <span class="text-sm md:text-base">대시보드</span>
      </a>
      <a href="participants.html" class="nav-item active flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-users mr-3"></i>
        <span class="text-sm md:text-base">참여자 관리</span>
      </a>
      <a href="feedback.html" class="nav-item flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-edit mr-3"></i>
        <span class="text-sm md:text-base">피드백 편집</span>
      </a>
      <a href="admin-management.html" class="nav-item flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-user-cog mr-3"></i>
        <span class="text-sm md:text-base">관리자 관리</span>
      </a>
      <a href="#" class="nav-item flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white" onclick="logout()">
        <i class="fas fa-sign-out-alt mr-3"></i>
        <span class="text-sm md:text-base">로그아웃</span>
      </a>
    </nav>
  </div>

  <!-- Main Content Area -->
  <div class="main-content ml-0 md:ml-64 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
      <div class="px-4 md:px-6 py-3 md:py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <button id="mobileMenuBtn" class="md:hidden mr-3 text-gray-600 hover:text-gray-800">
              <i class="fas fa-bars text-xl"></i>
            </button>
            <h2 class="text-lg md:text-2xl font-semibold text-gray-800">참여자 관리</h2>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4">
            <div class="hidden md:block text-sm text-gray-600" id="currentDateTime"></div>
            <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-2 md:px-4 py-1 md:py-2 rounded-lg text-xs md:text-sm">
              <i class="fas fa-sign-out-alt mr-1"></i>
              <span class="hidden md:inline">로그아웃</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="p-4 md:p-6">
      
      <!-- Success/Error Messages -->
      <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        <div class="flex items-center">
          <i class="fas fa-check-circle mr-2"></i>
          <span id="successText">작업이 성공적으로 완료되었습니다!</span>
        </div>
      </div>
      
      <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle mr-2"></i>
          <span id="errorText">오류가 발생했습니다.</span>
        </div>
      </div>

      <!-- 통계 카드 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <div class="flex items-center">
            <div class="bg-blue-100 p-2 rounded-lg mr-3">
              <i class="fas fa-users text-blue-600"></i>
            </div>
            <div>
              <p class="text-sm text-gray-600">총 참여자</p>
              <p class="text-xl font-semibold" id="totalParticipants">0</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <div class="flex items-center">
            <div class="bg-green-100 p-2 rounded-lg mr-3">
              <i class="fas fa-check-circle text-green-600"></i>
            </div>
            <div>
              <p class="text-sm text-gray-600">완료</p>
              <p class="text-xl font-semibold" id="completedCount">0</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <div class="flex items-center">
            <div class="bg-yellow-100 p-2 rounded-lg mr-3">
              <i class="fas fa-clock text-yellow-600"></i>
            </div>
            <div>
              <p class="text-sm text-gray-600">대기 중</p>
              <p class="text-xl font-semibold" id="pendingCount">0</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <div class="flex items-center">
            <div class="bg-red-100 p-2 rounded-lg mr-3">
              <i class="fas fa-times-circle text-red-600"></i>
            </div>
            <div>
              <p class="text-sm text-gray-600">만료</p>
              <p class="text-xl font-semibold" id="expiredCount">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 참여자 추가 탭 -->
      <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="border-b border-gray-200">
          <nav class="flex space-x-8 px-6">
            <button class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="individual">
              <i class="fas fa-user-plus mr-2"></i>개별 추가
            </button>
            <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="bulk">
              <i class="fas fa-file-upload mr-2"></i>엑셀 업로드
            </button>
          </nav>
        </div>
        
        <!-- 개별 추가 탭 -->
        <div id="individualTab" class="tab-content p-6">
          <form id="addParticipantForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-user mr-1"></i>성명 *
              </label>
              <input type="text" id="participantName" required
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="참여자 성명을 입력하세요">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-envelope mr-1"></i>이메일 *
              </label>
              <input type="email" id="participantEmail" required
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="이메일 주소를 입력하세요">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-building mr-1"></i>소속
              </label>
              <input type="text" id="participantOrganization"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="소속 기관을 입력하세요">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-briefcase mr-1"></i>직책
              </label>
              <input type="text" id="participantPosition"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="직책을 입력하세요">
            </div>
            
            <div class="md:col-span-2">
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">
                <i class="fas fa-plus mr-2"></i>참여자 추가
              </button>
            </div>
          </form>
        </div>
        
        <!-- 엑셀 업로드 탭 -->
        <div id="bulkTab" class="tab-content hidden p-6">
          <div class="space-y-4">
            <!-- 템플릿 다운로드 -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h4 class="font-medium text-blue-800">엑셀 템플릿 다운로드</h4>
                  <p class="text-sm text-blue-600 mt-1">참여자 정보를 일괄 등록하기 위한 엑셀 템플릿을 다운로드하세요.</p>
                </div>
                <button onclick="downloadTemplate()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                  <i class="fas fa-download mr-2"></i>템플릿 다운로드
                </button>
              </div>
            </div>
            
            <!-- 파일 업로드 영역 -->
            <div class="file-drop-area p-8 text-center" id="fileDropArea">
              <div class="max-w-md mx-auto">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-700 mb-2">엑셀 파일을 업로드하세요</h3>
                <p class="text-sm text-gray-500 mb-4">파일을 드래그 앤 드롭하거나 클릭하여 선택하세요</p>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="hidden">
                <button onclick="document.getElementById('excelFileInput').click()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                  <i class="fas fa-folder-open mr-2"></i>파일 선택
                </button>
              </div>
            </div>
            
            <!-- 업로드 진행 상황 -->
            <div id="uploadProgress" class="hidden">
              <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-gray-700">업로드 진행 상황</span>
                  <span class="text-sm text-gray-500" id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 0%"></div>
                </div>
              </div>
            </div>
            
            <!-- 미리보기 테이블 -->
            <div id="previewSection" class="hidden">
              <h4 class="font-medium text-gray-800 mb-3">업로드 미리보기</h4>
              <div class="bg-white border border-gray-200 rounded-lg">
                <div class="table-container">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">성명</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이메일</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">소속</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직책</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                      </tr>
                    </thead>
                    <tbody id="previewTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                  </table>
                </div>
                <div class="px-6 py-4 border-t border-gray-200">
                  <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                      <span id="validCount">0</span>개의 유효한 참여자, 
                      <span id="invalidCount">0</span>개의 오류
                    </div>
                    <div class="space-x-2">
                      <button onclick="cancelUpload()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-times mr-2"></i>취소
                      </button>
                      <button onclick="confirmUpload()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm" id="confirmUploadBtn">
                        <i class="fas fa-check mr-2"></i>확인 및 저장
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 참여자 목록 -->
      <div class="bg-white rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-800">참여자 목록</h3>
            <div class="flex items-center space-x-2">
              <!-- 검색 -->
              <div class="relative">
                <input type="text" id="searchInput" placeholder="검색..."
                       class="pl-8 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <i class="fas fa-search absolute left-2.5 top-2.5 text-gray-400 text-sm"></i>
              </div>
              
              <!-- 필터 -->
              <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">전체 상태</option>
                <option value="pending">대기 중</option>
                <option value="completed">완료</option>
                <option value="expired">만료</option>
              </select>
              
              <!-- 내보내기 -->
              <button onclick="exportParticipants()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm">
                <i class="fas fa-download mr-1"></i>내보내기
              </button>
            </div>
          </div>
        </div>
        
        <div class="table-container">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <input type="checkbox" id="selectAll" class="rounded border-gray-300">
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">성명</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이메일</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">소속</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">직책</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">등록일</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">액션</th>
              </tr>
            </thead>
            <tbody id="participantsTableBody" class="bg-white divide-y divide-gray-200">
              <!-- 참여자 데이터가 여기에 표시됩니다 -->
            </tbody>
          </table>
        </div>
        
        <!-- 대량 작업 버튼 -->
        <div id="bulkActions" class="hidden px-6 py-4 border-t border-gray-200 bg-gray-50">
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600"><span id="selectedCount">0</span>개 선택됨</span>
            <button onclick="bulkSendInvites()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
              <i class="fas fa-envelope mr-1"></i>초대 발송
            </button>
            <button onclick="bulkDelete()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
              <i class="fas fa-trash mr-1"></i>삭제
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 참여자 상세 모달 -->
  <div id="participantModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-lg max-w-md w-full">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">참여자 상세 정보</h3>
          <button onclick="closeParticipantModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <div id="participantDetails" class="space-y-3">
          <!-- 참여자 상세 정보가 여기에 표시됩니다 -->
        </div>
        
        <div class="mt-6 flex space-x-3">
          <button onclick="sendInvite()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
            <i class="fas fa-envelope mr-2"></i>초대 발송
          </button>
          <button onclick="editParticipant()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm">
            <i class="fas fa-edit mr-2"></i>수정
          </button>
          <button onclick="deleteParticipant()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg text-sm">
            <i class="fas fa-trash mr-2"></i>삭제
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 전역 변수
    let currentAdmin = null;
    let participants = [];
    let filteredParticipants = [];
    let selectedParticipants = [];
    let uploadedData = [];

    // 페이지 초기화
   document.addEventListener('DOMContentLoaded', function() {
  // Auth 시스템 초기화 (인증 체크 + 환영 메시지 + 비활성화 타이머 시작)
  if (!AdminAuth.init()) {
    return; // 인증 실패 시 리다이렉트됨
  }
  
  // 현재 관리자 정보 가져오기
  const currentAdmin = AdminAuth.getCurrentAdmin();
  
  // 나머지 페이지별 초기화 코드...
  updateDateTime();
  setInterval(updateDateTime, 60000);
  setupMobileMenu();
  // 페이지별 고유 초기화 함수들...
});
    // 모바일 메뉴 설정
    function setupMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');
      const closeSidebar = document.getElementById('closeSidebar');

      mobileMenuBtn.addEventListener('click', function() {
        sidebar.classList.add('mobile-open');
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      });

      function closeMobileMenu() {
        sidebar.classList.remove('mobile-open');
        overlay.classList.add('hidden');
        document.body.style.overflow = '';
      }

      closeSidebar.addEventListener('click', closeMobileMenu);
      overlay.addEventListener('click', closeMobileMenu);
    }

    // 탭 설정
    function setupTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          
          // 모든 탭 버튼에서 active 클래스 제거
          tabButtons.forEach(btn => {
            btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
            btn.classList.add('border-transparent', 'text-gray-500');
          });
          
          // 모든 탭 컨텐츠 숨기기
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          
          // 선택된 탭 활성화
          this.classList.add('active', 'border-blue-500', 'text-blue-600');
          this.classList.remove('border-transparent', 'text-gray-500');
          
          document.getElementById(tabId + 'Tab').classList.remove('hidden');
        });
      });
    }

    // 파일 업로드 설정
    function setupFileUpload() {
      const fileDropArea = document.getElementById('fileDropArea');
      const fileInput = document.getElementById('excelFileInput');

      // 드래그 앤 드롭 이벤트
      fileDropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
      });

      fileDropArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
      });

      fileDropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileUpload(files[0]);
        }
      });

      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0]);
        }
      });
    }

    // 검색 설정
    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');

      searchInput.addEventListener('input', filterParticipants);
      statusFilter.addEventListener('change', filterParticipants);
    }

    // 현재 시간 업데이트
    function updateDateTime() {
      const now = new Date();
      const dateTimeString = now.toLocaleString('ko-KR');
      const element = document.getElementById('currentDateTime');
      if (element) {
        element.textContent = dateTimeString;
      }
    }

    // 참여자 추가 (개별)
    document.getElementById('addParticipantForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const participant = {
        id: generateId(),
        name: document.getElementById('participantName').value,
        email: document.getElementById('participantEmail').value,
        organization: document.getElementById('participantOrganization').value,
        position: document.getElementById('participantPosition').value,
        status: 'pending',
        registeredAt: new Date().toISOString(),
        inviteSentAt: null,
        completedAt: null,
        uniqueCode: generateUniqueCode()
      };

      // 이메일 중복 체크
      if (participants.find(p => p.email === participant.email)) {
        showError('이미 등록된 이메일 주소입니다.');
        return;
      }

      participants.push(participant);
      saveParticipants();
      renderParticipants();
      updateStatistics();
      
      // 폼 초기화
      this.reset();
      showSuccess('참여자가 성공적으로 추가되었습니다.');
    });

    // 엑셀 템플릿 다운로드
    function downloadTemplate() {
      const template = [
        ['성명', '이메일', '소속', '직책'],
        ['홍길동', 'hong@example.com', 'ABC회사', '팀장'],
        ['김철수', 'kim@example.com', 'XYZ기관', '과장']
      ];

      const ws = XLSX.utils.aoa_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '참여자목록');
      
      // 열 너비 설정
      ws['!cols'] = [
        { width: 15 },
        { width: 25 },
        { width: 20 },
        { width: 15 }
      ];

      XLSX.writeFile(wb, '참여자_등록_템플릿.xlsx');
      showSuccess('템플릿 파일이 다운로드되었습니다.');
    }

    // 파일 업로드 처리
    function handleFileUpload(file) {
      if (!file.name.match(/\.(xlsx|xls)$/)) {
        showError('엑셀 파일만 업로드 가능합니다.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          processExcelData(jsonData);
        } catch (error) {
          showError('파일을 읽는 중 오류가 발생했습니다: ' + error.message);
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    // 엑셀 데이터 처리
    function processExcelData(data) {
      if (data.length < 2) {
        showError('데이터가 충분하지 않습니다.');
        return;
      }

      const headers = data[0];
      const rows = data.slice(1);
      
      uploadedData = [];
      let validCount = 0;
      let invalidCount = 0;

      rows.forEach((row, index) => {
        if (row.length === 0 || !row[0]) return; // 빈 행 스킵

        const participant = {
          rowIndex: index + 2,
          name: row[0] || '',
          email: row[1] || '',
          organization: row[2] || '',
          position: row[3] || '',
          isValid: true,
          errors: []
        };

        // 유효성 검사
        if (!participant.name.trim()) {
          participant.errors.push('성명이 필요합니다');
          participant.isValid = false;
        }

        if (!participant.email.trim()) {
          participant.errors.push('이메일이 필요합니다');
          participant.isValid = false;
        } else if (!isValidEmail(participant.email)) {
          participant.errors.push('올바른 이메일 형식이 아닙니다');
          participant.isValid = false;
        } else if (participants.find(p => p.email === participant.email)) {
          participant.errors.push('이미 등록된 이메일입니다');
          participant.isValid = false;
        }

        uploadedData.push(participant);
        
        if (participant.isValid) {
          validCount++;
        } else {
          invalidCount++;
        }
      });

      // 미리보기 표시
      displayUploadPreview(validCount, invalidCount);
    }

    // 업로드 미리보기 표시
    function displayUploadPreview(validCount, invalidCount) {
      const previewSection = document.getElementById('previewSection');
      const previewTableBody = document.getElementById('previewTableBody');
      const validCountElement = document.getElementById('validCount');
      const invalidCountElement = document.getElementById('invalidCount');
      const confirmBtn = document.getElementById('confirmUploadBtn');

      previewSection.classList.remove('hidden');
      validCountElement.textContent = validCount;
      invalidCountElement.textContent = invalidCount;
      
      // 확인 버튼 활성화/비활성화
      confirmBtn.disabled = validCount === 0;
      if (validCount === 0) {
        confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }

      // 테이블 내용 생성
      previewTableBody.innerHTML = '';
      uploadedData.forEach(participant => {
        const row = document.createElement('tr');
        row.className = participant.isValid ? '' : 'bg-red-50';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${participant.name}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${participant.email}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${participant.organization}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${participant.position}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            ${participant.isValid 
              ? '<span class="status-badge status-pending">유효</span>'
              : `<span class="status-badge status-expired">오류</span>
                 <div class="text-xs text-red-600 mt-1">${participant.errors.join(', ')}</div>`
            }
          </td>
        `;
        
        previewTableBody.appendChild(row);
      });
    }

    // 업로드 확인
    function confirmUpload() {
      const validParticipants = uploadedData.filter(p => p.isValid);
      
      if (validParticipants.length === 0) {
        showError('유효한 참여자가 없습니다.');
        return;
      }

      // 진행률 표시
      const progressSection = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      progressSection.classList.remove('hidden');
      
      let processed = 0;
      const total = validParticipants.length;

      validParticipants.forEach((participantData, index) => {
        setTimeout(() => {
          const participant = {
            id: generateId(),
            name: participantData.name.trim(),
            email: participantData.email.trim(),
            organization: participantData.organization.trim(),
            position: participantData.position.trim(),
            status: 'pending',
            registeredAt: new Date().toISOString(),
            inviteSentAt: null,
            completedAt: null,
            uniqueCode: generateUniqueCode()
          };

          participants.push(participant);
          processed++;
          
          // 진행률 업데이트
          const progress = Math.round((processed / total) * 100);
          progressBar.style.width = progress + '%';
          progressText.textContent = progress + '%';
          
          // 완료 처리
          if (processed === total) {
            setTimeout(() => {
              saveParticipants();
              renderParticipants();
              updateStatistics();
              cancelUpload();
              showSuccess(`${total}명의 참여자가 성공적으로 등록되었습니다.`);
            }, 500);
          }
        }, index * 100); // 0.1초씩 지연
      });
    }

    // 업로드 취소
    function cancelUpload() {
      document.getElementById('previewSection').classList.add('hidden');
      document.getElementById('uploadProgress').classList.add('hidden');
      document.getElementById('excelFileInput').value = '';
      uploadedData = [];
    }

    // 참여자 목록 로드
    function loadParticipants() {
      const saved = localStorage.getItem('participants');
      if (saved) {
        participants = JSON.parse(saved);
      }
      renderParticipants();
    }

    // 참여자 목록 저장
    function saveParticipants() {
      localStorage.setItem('participants', JSON.stringify(participants));
    }

    // 참여자 목록 렌더링
    function renderParticipants() {
      const tbody = document.getElementById('participantsTableBody');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      
      // 필터링
      filteredParticipants = participants.filter(participant => {
        const matchesSearch = !searchTerm || 
          participant.name.toLowerCase().includes(searchTerm) ||
          participant.email.toLowerCase().includes(searchTerm) ||
          (participant.organization && participant.organization.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || participant.status === statusFilter;
        
        return matchesSearch && matchesStatus;
      });

      tbody.innerHTML = '';
      
      if (filteredParticipants.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-6 py-8 text-center text-gray-500">
              <i class="fas fa-users text-4xl mb-2"></i>
              <div>등록된 참여자가 없습니다.</div>
            </td>
          </tr>
        `;
        return;
      }

      filteredParticipants.forEach(participant => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        const statusClass = {
          pending: 'status-pending',
          completed: 'status-completed',
          expired: 'status-expired'
        }[participant.status] || 'status-pending';
        
        const statusText = {
          pending: '대기 중',
          completed: '완료',
          expired: '만료'
        }[participant.status] || '대기 중';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <input type="checkbox" class="participant-checkbox rounded border-gray-300" 
                   value="${participant.id}" onchange="updateBulkActions()">
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${participant.name}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${participant.email}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${participant.organization || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${participant.position || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="status-badge ${statusClass}">${statusText}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${new Date(participant.registeredAt).toLocaleDateString('ko-KR')}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button onclick="viewParticipant('${participant.id}')" 
                    class="text-blue-600 hover:text-blue-900 mr-2">
              <i class="fas fa-eye"></i>
            </button>
            <button onclick="sendInviteToParticipant('${participant.id}')" 
                    class="text-green-600 hover:text-green-900 mr-2">
              <i class="fas fa-envelope"></i>
            </button>
            <button onclick="deleteParticipantById('${participant.id}')" 
                    class="text-red-600 hover:text-red-900">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // 참여자 필터링
    function filterParticipants() {
      renderParticipants();
    }

    // 통계 업데이트
    function updateStatistics() {
      const total = participants.length;
      const completed = participants.filter(p => p.status === 'completed').length;
      const pending = participants.filter(p => p.status === 'pending').length;
      const expired = participants.filter(p => p.status === 'expired').length;

      document.getElementById('totalParticipants').textContent = total;
      document.getElementById('completedCount').textContent = completed;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('expiredCount').textContent = expired;
    }

    // 대량 작업 업데이트
    function updateBulkActions() {
      const checkboxes = document.querySelectorAll('.participant-checkbox:checked');
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      
      selectedParticipants = Array.from(checkboxes).map(cb => cb.value);
      selectedCount.textContent = selectedParticipants.length;
      
      if (selectedParticipants.length > 0) {
        bulkActions.classList.remove('hidden');
      } else {
        bulkActions.classList.add('hidden');
      }
    }

    // 전체 선택
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.participant-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = this.checked;
      });
      updateBulkActions();
    });

    // 참여자 상세보기
    function viewParticipant(id) {
      const participant = participants.find(p => p.id === id);
      if (!participant) return;

      const modal = document.getElementById('participantModal');
      const details = document.getElementById('participantDetails');
      
      details.innerHTML = `
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-600">성명</label>
            <p class="text-gray-900">${participant.name}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600">이메일</label>
            <p class="text-gray-900">${participant.email}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600">소속</label>
            <p class="text-gray-900">${participant.organization || '-'}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600">직책</label>
            <p class="text-gray-900">${participant.position || '-'}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600">상태</label>
            <p class="text-gray-900">${getStatusText(participant.status)}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600">등록일</label>
            <p class="text-gray-900">${new Date(participant.registeredAt).toLocaleDateString('ko-KR')}</p>
          </div>
          <div class="col-span-2">
            <label class="text-sm font-medium text-gray-600">진단 링크</label>
            <div class="mt-1 flex">
              <input type="text" readonly 
                     value="${generateDiagnosisLink(participant.uniqueCode)}"
                     class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50 text-sm">
              <button onclick="copyToClipboard('${generateDiagnosisLink(participant.uniqueCode)}')"
                      class="px-3 py-2 bg-gray-600 text-white rounded-r-lg hover:bg-gray-700">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // 모달 닫기
    function closeParticipantModal() {
      document.getElementById('participantModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // 초대 발송
    function sendInviteToParticipant(id) {
      const participant = participants.find(p => p.id === id);
      if (!participant) return;

      // 실제 이메일 발송 로직 구현
      console.log(`초대 발송: ${participant.email}`);
      
      // 발송 시간 기록
      participant.inviteSentAt = new Date().toISOString();
      saveParticipants();
      renderParticipants();
      
      showSuccess(`${participant.name}님에게 초대가 발송되었습니다.`);
    }

    // 참여자 삭제
    function deleteParticipantById(id) {
      if (!confirm('정말로 이 참여자를 삭제하시겠습니까?')) return;
      
      participants = participants.filter(p => p.id !== id);
      saveParticipants();
      renderParticipants();
      updateStatistics();
      
      showSuccess('참여자가 삭제되었습니다.');
    }

    // 대량 초대 발송
    function bulkSendInvites() {
      if (selectedParticipants.length === 0) return;
      
      if (!confirm(`선택된 ${selectedParticipants.length}명에게 초대를 발송하시겠습니까?`)) return;
      
      selectedParticipants.forEach(id => {
        const participant = participants.find(p => p.id === id);
        if (participant) {
          participant.inviteSentAt = new Date().toISOString();
        }
      });
      
      saveParticipants();
      renderParticipants();
      updateBulkActions();
      
      showSuccess(`${selectedParticipants.length}명에게 초대가 발송되었습니다.`);
    }

    // 대량 삭제
    function bulkDelete() {
      if (selectedParticipants.length === 0) return;
      
      if (!confirm(`선택된 ${selectedParticipants.length}명을 삭제하시겠습니까?`)) return;
      
      participants = participants.filter(p => !selectedParticipants.includes(p.id));
      selectedParticipants = [];
      
      saveParticipants();
      renderParticipants();
      updateStatistics();
      updateBulkActions();
      
      showSuccess('선택된 참여자들이 삭제되었습니다.');
    }

    // 참여자 목록 내보내기
    function exportParticipants() {
      if (participants.length === 0) {
        showError('내보낼 데이터가 없습니다.');
        return;
      }

      const exportData = [
        ['성명', '이메일', '소속', '직책', '상태', '등록일', '초대발송일', '완료일', '진단링크']
      ];

      participants.forEach(participant => {
        exportData.push([
          participant.name,
          participant.email,
          participant.organization || '',
          participant.position || '',
          getStatusText(participant.status),
          new Date(participant.registeredAt).toLocaleDateString('ko-KR'),
          participant.inviteSentAt ? new Date(participant.inviteSentAt).toLocaleDateString('ko-KR') : '',
          participant.completedAt ? new Date(participant.completedAt).toLocaleDateString('ko-KR') : '',
          generateDiagnosisLink(participant.uniqueCode)
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '참여자목록');
      
      // 열 너비 설정
      ws['!cols'] = [
        { width: 15 }, // 성명
        { width: 25 }, // 이메일
        { width: 20 }, // 소속
        { width: 15 }, // 직책
        { width: 10 }, // 상태
        { width: 12 }, // 등록일
        { width: 12 }, // 초대발송일
        { width: 12 }, // 완료일
        { width: 50 }  // 진단링크
      ];

      const today = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `참여자목록_${today}.xlsx`);
      
      showSuccess('참여자 목록이 내보내기되었습니다.');
    }

    // 유틸리티 함수들
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function generateUniqueCode() {
      return Math.random().toString(36).substr(2, 8).toUpperCase();
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function getStatusText(status) {
      const statusMap = {
        pending: '대기 중',
        completed: '완료',
        expired: '만료'
      };
      return statusMap[status] || '대기 중';
    }

    function generateDiagnosisLink(code) {
      return `${window.location.origin}/diagnosis.html?code=${code}`;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showSuccess('링크가 클립보드에 복사되었습니다.');
      }).catch(() => {
        showError('복사에 실패했습니다.');
      });
    }

    function showSuccess(message) {
      const element = document.getElementById('successMessage');
      const textElement = document.getElementById('successText');
      textElement.textContent = message;
      element.classList.remove('hidden');
      setTimeout(() => {
        element.classList.add('hidden');
      }, 3000);
    }

    function showError(message) {
      const element = document.getElementById('errorMessage');
      const textElement = document.getElementById('errorText');
      textElement.textContent = message;
      element.classList.remove('hidden');
      setTimeout(() => {
        element.classList.add('hidden');
      }, 3000);
    }

    // 로그아웃
    function logout() {
      if (confirm('로그아웃 하시겠습니까?')) {
        if (typeof window.AdminAuth !== 'undefined') {
          window.AdminAuth.logout();
        } else {
          window.location.href = 'index.html';
        }
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>참여자 관리 - 리더십 진단 관리자</title>
  
  <!-- config.js를 동기적으로 로드 -->
  <script src="https://sadh911122-sudo.github.io/Dark_Triad_admin/config.js"></script>
  
  <!-- config.js 로드 확인 스크립트 -->
  <script>
    console.log('즉시 실행 - GOOGLE_CONFIG:', typeof GOOGLE_CONFIG);
    
    // DOM 로드 후 다시 확인
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM 로드 후 - GOOGLE_CONFIG:', typeof GOOGLE_CONFIG);
      if (typeof GOOGLE_CONFIG !== 'undefined') {
        console.log('GOOGLE_CONFIG 내용:', GOOGLE_CONFIG);
      } else {
        console.error('GOOGLE_CONFIG가 여전히 undefined입니다.');
      }
    });
  </script>
  
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
    }
    
    .nav-item {
      transition: all 0.3s ease;
    }
    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-item.active {
      background-color: rgba(255, 255, 255, 0.2);
      border-left: 4px solid #fff;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0 !important;
      }
      .mobile-overlay {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
      }
    }
    
    .file-drop-area {
      border: 2px dashed #cbd5e0;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }
    .file-drop-area.dragover {
      border-color: #3182ce;
      background-color: #ebf8ff;
    }
    
    .table-container {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
    }
    .status-completed {
      background-color: #d1fae5;
      color: #065f46;
    }
    .status-expired {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .tab-button.active {
      border-bottom-color: #3b82f6;
      color: #3b82f6;
    }
    .tab-button {
      border-bottom-color: transparent;
      color: #6b7280;
    }
  </style>
</head>
<body class="bg-gray-50">
  
  <!-- Mobile Menu Overlay -->
  <div id="mobileOverlay" class="fixed inset-0 mobile-overlay z-40 hidden md:hidden"></div>
  
  <!-- Navigation Sidebar -->
  <div id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 bg-gray-800 text-white z-50">
    <div class="p-4 md:p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-lg md:text-xl font-bold">관리자 대시보드</h1>
          <p class="text-gray-400 text-xs md:text-sm" id="adminWelcome">관리자님 환영합니다</p>
        </div>
        <button id="closeSidebar" class="md:hidden text-white hover:text-gray-300">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>
    
    <nav class="mt-4 md:mt-8">
      <a href="dashboard.html" class="nav-item flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-tachometer-alt mr-3"></i>
        <span class="text-sm md:text-base">대시보드</span>
      </a>
      <a href="participants.html" class="nav-item active flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-users mr-3"></i>
        <span class="text-sm md:text-base">참여자 관리</span>
      </a>
      <a href="feedback.html" class="nav-item flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-edit mr-3"></i>
        <span class="text-sm md:text-base">피드백 편집</span>
      </a>
      <a href="#" class="nav-item flex items-center px-4 md:px-6 py-3 text-gray-300 hover:text-white" onclick="logout()">
        <i class="fas fa-sign-out-alt mr-3"></i>
        <span class="text-sm md:text-base">로그아웃</span>
      </a>
    </nav>
  </div>

  <!-- Main Content Area -->
  <div class="main-content ml-0 md:ml-64 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
      <div class="px-4 md:px-6 py-3 md:py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <button id="mobileMenuBtn" class="md:hidden mr-3 text-gray-600 hover:text-gray-800">
              <i class="fas fa-bars text-xl"></i>
            </button>
            <h2 class="text-lg md:text-2xl font-semibold text-gray-800">참여자 관리</h2>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4">
            <div class="hidden md:block text-sm text-gray-600" id="currentDateTime"></div>
            <button id="googleSignInBtn" onclick="handleGoogleSignIn()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">
              <i class="fab fa-google mr-1"></i>
              <span class="hidden md:inline">Google 연동</span>
            </button>
            <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-2 md:px-4 py-1 md:py-2 rounded-lg text-xs md:text-sm">
              <i class="fas fa-sign-out-alt mr-1"></i>
              <span class="hidden md:inline">로그아웃</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="p-4 md:p-6">
      
      <!-- Google 연동 상태 알림 -->
      <div id="googleStatusAlert" class="hidden mb-6 p-4 rounded-lg">
        <div class="flex items-center">
          <i id="googleStatusIcon" class="mr-2"></i>
          <span id="googleStatusText"></span>
        </div>
      </div>

      <!-- 탭 네비게이션 -->
      <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="border-b border-gray-200">
          <nav class="flex space-x-8 px-6">
            <button onclick="showTab('individual')" 
                    class="tab-button py-4 px-2 border-b-2 font-medium text-sm active border-blue-500 text-blue-600">
              <i class="fas fa-user-plus mr-2"></i>개별 추가
            </button>
            <button onclick="showTab('bulk')" 
                    class="tab-button py-4 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500">
              <i class="fas fa-file-excel mr-2"></i>일괄 업로드
            </button>
            <button onclick="showTab('manage')" 
                    class="tab-button py-4 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500">
              <i class="fas fa-list mr-2"></i>참여자 목록
            </button>
          </nav>
        </div>

        <!-- 개별 추가 탭 -->
        <div id="individualTab" class="tab-content p-6">
          <h3 class="text-lg font-semibold mb-4">새 참여자 추가</h3>
          
          <form id="addParticipantForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">이름 *</label>
                <input type="text" id="participantName" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">이메일 *</label>
                <input type="email" id="participantEmail" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">소속</label>
                <input type="text" id="participantOrg"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">직책</label>
                <input type="text" id="participantPosition"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
            </div>
            
            <div class="flex justify-end">
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                <i class="fas fa-plus mr-2"></i>참여자 추가
              </button>
            </div>
          </form>
        </div>

        <!-- 일괄 업로드 탭 -->
        <div id="bulkTab" class="tab-content p-6 hidden">
          <h3 class="text-lg font-semibold mb-4">엑셀 파일 업로드</h3>
          
          <div class="mb-4">
            <button onclick="downloadTemplate()" 
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
              <i class="fas fa-download mr-2"></i>템플릿 다운로드
            </button>
          </div>
          
          <div class="file-drop-area p-8 text-center">
            <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden">
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 mb-2">엑셀 파일을 여기에 드래그하거나</p>
            <button onclick="document.getElementById('excelFile').click()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
              파일 선택
            </button>
          </div>
          
          <div id="uploadResult" class="mt-4 hidden"></div>
        </div>

        <!-- 참여자 목록 탭 -->
        <div id="manageTab" class="tab-content p-6 hidden">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">참여자 목록</h3>
            <div class="flex space-x-2">
              <input type="text" id="searchInput" placeholder="이름, 이메일로 검색..."
                     class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
              <button onclick="refreshParticipants()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
          
          <div class="table-container">
            <table class="min-w-full bg-white border border-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">이름</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">이메일</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">소속</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">참여코드</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">작업</th>
                </tr>
              </thead>
              <tbody id="participantsTableBody" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-2"></i>데이터를 불러오는 중...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 전역 변수
    let currentAdmin = null;
    let currentTab = 'individual';
    let participants = [];

    // 페이지 초기화
    document.addEventListener('DOMContentLoaded', async function() {
      checkAuth();
      updateDateTime();
      setInterval(updateDateTime, 60000);
      setupMobileMenu();
      setupTabs();
      setupFileUpload();
      setupSearch();
      setupFormSubmission();
      
      // Google API 초기화 시도 (config.js 함수 사용)
      try {
        if (typeof initializeGoogleAPI === 'function') {
          await initializeGoogleAPI();
          updateGoogleStatus(true, 'Google Sheets와 연결되었습니다.');
        } else {
          throw new Error('initializeGoogleAPI 함수를 찾을 수 없습니다.');
        }
        refreshParticipants();
      } catch (error) {
        console.log('Google API 초기화 실패:', error);
        updateGoogleStatus(false, 'Google 연동이 필요합니다. 연동 버튼을 클릭하세요.');
        // 로컬 데이터라도 로드
        refreshParticipants();
      }
    });

    // 인증 체크
    function checkAuth() {
      const adminData = localStorage.getItem('currentAdmin');
      if (!adminData) {
        // 테스트용 관리자 데이터 생성
        currentAdmin = {
          id: 'admin1',
          name: '관리자',
          email: 'admin@test.com'
        };
        localStorage.setItem('currentAdmin', JSON.stringify(currentAdmin));
      } else {
        currentAdmin = JSON.parse(adminData);
      }
      
      document.getElementById('adminWelcome').textContent = `${currentAdmin.name}님 환영합니다`;
      return true;
    }

    // Google 로그인 처리 (config.js 함수 사용)
    async function handleGoogleSignIn() {
      try {
        if (typeof initializeGoogleAPI === 'function') {
          await initializeGoogleAPI();
        }
        
        if (typeof isUserSignedIn === 'function' && typeof signInUser === 'function') {
          if (!isUserSignedIn()) {
            await signInUser();
          }
        }
        
        updateGoogleStatus(true, 'Google 계정에 연결되었습니다.');
        refreshParticipants();
      } catch (error) {
        console.error('Google 연동 오류:', error);
        updateGoogleStatus(false, 'Google 연동에 실패했습니다: ' + (error?.message || JSON.stringify(error)));
      }
    }

    // Google 연동 상태 업데이트
    function updateGoogleStatus(isConnected, message) {
      const alert = document.getElementById('googleStatusAlert');
      const icon = document.getElementById('googleStatusIcon');
      const text = document.getElementById('googleStatusText');
      const signInBtn = document.getElementById('googleSignInBtn');
      
      alert.className = `mb-6 p-4 rounded-lg ${isConnected ? 'bg-green-100 border border-green-400 text-green-700' : 'bg-yellow-100 border border-yellow-400 text-yellow-700'}`;
      icon.className = `mr-2 fas ${isConnected ? 'fa-check-circle' : 'fa-exclamation-triangle'}`;
      text.textContent = message;
      alert.classList.remove('hidden');
      
      signInBtn.innerHTML = isConnected ? 
        '<i class="fas fa-check mr-1"></i><span class="hidden md:inline">연동됨</span>' :
        '<i class="fab fa-google mr-1"></i><span class="hidden md:inline">Google 연동</span>';
      signInBtn.className = isConnected ? 
        'bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm' :
        'bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm';
    }

    // 탭 설정
    function setupTabs() {
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
          const onclick = this.getAttribute('onclick');
          if (onclick) {
            const match = onclick.match(/showTab\('(.+?)'\)/);
            if (match) {
              showTab(match[1]);
            }
          }
        });
      });
    }

    function showTab(tabName) {
      currentTab = tabName;
      
      // 탭 버튼 스타일 업데이트
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
      });
      
      // 활성 탭 스타일
      const activeButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
      if (activeButton) {
        activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
        activeButton.classList.remove('border-transparent', 'text-gray-500');
      }
      
      // 탭 콘텐츠 표시/숨김
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      const targetTab = document.getElementById(`${tabName}Tab`);
      if (targetTab) {
        targetTab.classList.remove('hidden');
      }
      
      // 참여자 목록 탭이 선택되면 데이터 새로고침
      if (tabName === 'manage') {
        refreshParticipants();
      }
    }

    // 폼 제출 설정
    function setupFormSubmission() {
      const form = document.getElementById('addParticipantForm');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const participantData = {
            name: document.getElementById('participantName').value,
            email: document.getElementById('participantEmail').value,
            organization: document.getElementById('participantOrg').value,
            position: document.getElementById('participantPosition').value
          };
          
          try {
            await addParticipant(participantData);
          } catch (error) {
            console.error('참여자 추가 실패:', error);
          }
        });
      }
    }

    // 상태 텍스트 반환
    function getStatusText(status) {
      const statusMap = {
        'pending': '대기중',
        'completed': '완료',
        'expired': '만료'
      };
      return statusMap[status] || status;
    }

    // 참여 코드 생성
    function generateParticipantCode() {
      const prefix = 'LDT-';
      const randomNum = Math.random().toString(36).substring(2, 8).toUpperCase();
      return prefix + randomNum;
    }

    // 참여자 추가 (config.js 함수 사용)
    async function addParticipant(participantData) {
      try {
        const participant = {
          id: Date.now(),
          name: participantData.name,
          email: participantData.email,
          organization: participantData.organization || '',
          position: participantData.position || '',
          code: generateParticipantCode(),
          status: 'pending',
          adminId: currentAdmin.id,
          createdAt: new Date().toISOString()
        };

        // config.js의 함수 사용
        if (typeof isUserSignedIn === 'function' && isUserSignedIn() && typeof saveParticipant === 'function') {
          await saveParticipant(participant);
        } else {
          // localStorage에 저장
          const localParticipants = JSON.parse(localStorage.getItem('participants') || '[]');
          localParticipants.push(participant);
          localStorage.setItem('participants', JSON.stringify(localParticipants));
        }

        showSuccessMessage('참여자가 성공적으로 추가되었습니다.');
        document.getElementById('addParticipantForm').reset();
        refreshParticipants();
        
        return participant;
      } catch (error) {
        showErrorMessage('참여자 추가 중 오류가 발생했습니다: ' + error.message);
        throw error;
      }
    }

    // 참여자 목록 새로고침 (config.js 함수 사용)
    async function refreshParticipants() {
      try {
        // config.js의 getParticipants 함수 사용
        if (typeof getParticipants === 'function') {
          participants = await getParticipants();
        } else {
          // fallback: localStorage 사용
          participants = JSON.parse(localStorage.getItem('participants') || '[]');
        }
        
        renderParticipantsTable(participants);
      } catch (error) {
        showErrorMessage('참여자 목록을 불러오는 중 오류가 발생했습니다: ' + error.message);
        renderParticipantsTable([]);
      }
    }

    // 참여자 테이블 렌더링
    function renderParticipantsTable(participantList) {
      const tbody = document.getElementById('participantsTableBody');
      
      if (participantList.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
              <i class="fas fa-users mr-2"></i>등록된 참여자가 없습니다.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = participantList.map(participant => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm font-medium text-gray-900">${participant.name}</td>
          <td class="px-4 py-3 text-sm text-gray-500">${participant.email}</td>
          <td class="px-4 py-3 text-sm text-gray-500">${participant.organization || '-'}</td>
          <td class="px-4 py-3 text-sm font-mono text-gray-700">${participant.code}</td>
          <td class="px-4 py-3">
            <span class="status-badge status-${participant.status}">
              ${getStatusText(participant.status)}
            </span>
          </td>
          <td class="px-4 py-3">
            <div class="flex space-x-2">
              <button onclick="sendCode('${participant.code}', '${participant.email}')" 
                      class="text-blue-600 hover:text-blue-800 text-sm" title="코드 발송">
                <i class="fas fa-paper-plane"></i>
              </button>
              <button onclick="copyDiagnosisLink('${participant.code}')" 
                      class="text-green-600 hover:text-green-800 text-sm" title="링크 복사">
                <i class="fas fa-link"></i>
              </button>
              <button onclick="deleteParticipant('${participant.code}')" 
                      class="text-red-600 hover:text-red-800 text-sm" title="삭제">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // 엑셀 업로드 처리
    function setupFileUpload() {
      const fileInput = document.getElementById('excelFile');
      if (fileInput) {
        fileInput.addEventListener('change', handleExcelUpload);
      }

      const dropArea = document.querySelector('.file-drop-area');
      if (dropArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
          dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
          dropArea.classList.add('dragover');
        }
        
        function unhighlight() {
          dropArea.classList.remove('dragover');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            document.getElementById('excelFile').files = files;
            handleExcelUpload({ target: { files: files } });
          }
        }
      }
    }

    async function handleExcelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);

          let successCount = 0;
          const errors = [];

          for (const row of jsonData) {
            try {
              if (row.name && row.email) {
                await addParticipant({
                  name: row.name,
                  email: row.email,
                  organization: row.organization || '',
                  position: row.position || ''
                });
                successCount++;
              }
            } catch (error) {
              errors.push(`${row.name}: ${error.message}`);
            }
          }

          const resultDiv = document.getElementById('uploadResult');
          resultDiv.className = 'mt-4 p-4 rounded-lg';
          
          if (errors.length === 0) {
            resultDiv.className += ' bg-green-100 border border-green-400 text-green-700';
            resultDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${successCount}명의 참여자가 성공적으로 추가되었습니다.`;
          } else {
            resultDiv.className += ' bg-yellow-100 border border-yellow-400 text-yellow-700';
            resultDiv.innerHTML = `
              <i class="fas fa-exclamation-triangle mr-2"></i>
              ${successCount}명 성공, ${errors.length}명 실패
              <details class="mt-2">
                <summary class="cursor-pointer">오류 내용 보기</summary>
                <ul class="mt-2 text-sm">
                  ${errors.map(error => `<li>• ${error}</li>`).join('')}
                </ul>
              </details>
            `;
          }
          
          resultDiv.classList.remove('hidden');
          refreshParticipants();
          
        } catch (error) {
          showErrorMessage('엑셀 파일 처리 중 오류가 발생했습니다: ' + error.message);
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    // 템플릿 다운로드
    function downloadTemplate() {
      const template = [
        ['name', 'email', 'organization', 'position'],
        ['홍길동', 'hong@example.com', '샘플 회사', '팀장'],
        ['김철수', 'kim@example.com', '샘플 회사', '대리']
      ];
      
      const ws = XLSX.utils.aoa_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Participants');
      XLSX.writeFile(wb, 'participants_template.xlsx');
    }

    // 코드 발송 (config.js 함수 사용)
    async function sendCode(code, email) {
      try {
        const participant = participants.find(p => p.code === code);
        if (!participant) {
          throw new Error('참여자를 찾을 수 없습니다.');
        }
        
        // config.js의 sendParticipationCodeEmail 함수 사용
        if (typeof sendParticipationCodeEmail === 'function') {
          await sendParticipationCodeEmail(participant);
        } else {
          throw new Error('이메일 발송 기능을 사용할 수 없습니다.');
        }
        
        showMessage('참여코드가 성공적으로 발송되었습니다.', 'success');
      } catch (error) {
        showMessage('이메일 발송 중 오류가 발생했습니다: ' + error.message, 'error');
      }
    }

    // 진단 링크 복사 (경로 수정)
    function copyDiagnosisLink(code) {
      const link = `${window.location.origin}/Dark_Triad_admin/diagnosis.html?code=${code}`;
      copyToClipboard(link);
    }

    // 클립보드 복사
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showSuccessMessage('진단 링크가 클립보드에 복사되었습니다.');
      }).catch(() => {
        showErrorMessage('복사에 실패했습니다.');
      });
    }

    // 참여자 삭제 (config.js 함수 사용)
    async function deleteParticipant(code) {
      if (!confirm('정말로 이 참여자를 삭제하시겠습니까?')) return;
      
      try {
        // config.js의 updateParticipantStatus 함수 사용
        if (typeof isUserSignedIn === 'function' && isUserSignedIn() && typeof updateParticipantStatus === 'function') {
          await updateParticipantStatus(code, 'deleted');
        } else {
          // localStorage에서 삭제
          const localParticipants = JSON.parse(localStorage.getItem('participants') || '[]');
          const filteredParticipants = localParticipants.filter(p => p.code !== code);
          localStorage.setItem('participants', JSON.stringify(filteredParticipants));
        }
        
        showSuccessMessage('참여자가 삭제되었습니다.');
        refreshParticipants();
      } catch (error) {
        showErrorMessage('참여자 삭제 중 오류가 발생했습니다: ' + error.message);
      }
    }

    // 검색 기능
    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const filteredParticipants = participants.filter(p => 
            p.name.toLowerCase().includes(searchTerm) || 
            p.email.toLowerCase().includes(searchTerm) ||
            (p.organization && p.organization.toLowerCase().includes(searchTerm))
          );
          renderParticipantsTable(filteredParticipants);
        });
      }
    }

    // 모바일 메뉴 설정
    function setupMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');
      const closeSidebar = document.getElementById('closeSidebar');

      if (mobileMenuBtn && sidebar && overlay && closeSidebar) {
        mobileMenuBtn.addEventListener('click', function() {
          sidebar.classList.add('mobile-open');
          overlay.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        });

        function closeMobileMenu() {
          sidebar.classList.remove('mobile-open');
          overlay.classList.add('hidden');
          document.body.style.overflow = '';
        }

        closeSidebar.addEventListener('click', closeMobileMenu);
        overlay.addEventListener('click', closeMobileMenu);
      }
    }

    // 현재 시간 업데이트
    function updateDateTime() {
      const now = new Date();
      const dateTimeString = now.toLocaleString('ko-KR');
      const element = document.getElementById('currentDateTime');
      if (element) {
        element.textContent = dateTimeString;
      }
    }

    // 성공 메시지 표시
    function showSuccessMessage(message) {
      showMessage(message, 'success');
    }

    // 오류 메시지 표시
    function showErrorMessage(message) {
      showMessage(message, 'error');
    }

    // 메시지 표시
    function showMessage(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 
        'bg-red-100 border border-red-400 text-red-700'
      }`;
      alertDiv.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i>
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg">&times;</button>
        </div>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // 로그아웃
    function logout() {
      if (confirm('로그아웃 하시겠습니까?')) {
        localStorage.removeItem('currentAdmin');
        if (typeof isUserSignedIn === 'function' && typeof signOutUser === 'function' && isUserSignedIn()) {
          signOutUser();
        }
        window.location.href = 'index.html';
      }
    }

    // 개발자 도구 (개발 환경에서만 사용)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      window.devTools = {
        generateTestData: () => {
          const testParticipants = [
            {
              id: Date.now(),
              name: '홍길동',
              email: 'hong@example.com',
              organization: '테스트 회사',
              position: '팀장',
              code: 'LDT-TEST01',
              status: 'pending',
              adminId: 'admin1',
              createdAt: new Date().toISOString()
            },
            {
              id: Date.now() + 1,
              name: '김철수',
              email: 'kim@example.com',
              organization: '샘플 기업',
              position: '대리',
              code: 'LDT-TEST02',
              status: 'completed',
              adminId: 'admin1',
              createdAt: new Date().toISOString()
            }
          ];
          
          const existingParticipants = JSON.parse(localStorage.getItem('participants') || '[]');
          const allParticipants = [...existingParticipants, ...testParticipants];
          localStorage.setItem('participants', JSON.stringify(allParticipants));
          refreshParticipants();
          showSuccessMessage('테스트 데이터가 생성되었습니다.');
        },
        clearData: () => {
          localStorage.removeItem('participants');
          refreshParticipants();
          showSuccessMessage('모든 참여자 데이터가 삭제되었습니다.');
        },
        viewData: () => {
          console.log('현재 참여자 데이터:', JSON.parse(localStorage.getItem('participants') || '[]'));
        }
      };
      
      console.log('개발 환경에서 devTools 사용 가능:', window.devTools);
    }

    // 페이지 로드 완료 후 추가 초기화
    window.addEventListener('load', function() {
      console.log('참여자 관리 페이지가 로드되었습니다.');
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>대시보드 - 리더십 진단 관리자</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
    }
    .nav-item {
      transition: all 0.3s ease;
    }
    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-item.active {
      background-color: rgba(255, 255, 255, 0.2);
      border-left: 4px solid #fff;
    }
  </style>
</head>
<body class="bg-gray-100">
  
  <!-- Navigation Sidebar -->
  <div class="fixed inset-y-0 left-0 w-64 bg-gray-800 text-white">
    <div class="p-6">
      <h1 class="text-xl font-bold">관리자 대시보드</h1>
      <p class="text-gray-400 text-sm" id="adminWelcome">환영합니다</p>
    </div>
    
    <nav class="mt-8">
      <a href="dashboard.html" class="nav-item active flex items-center px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-tachometer-alt mr-3"></i>대시보드
      </a>
      <a href="participants.html" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-users mr-3"></i>참여자 관리
      </a>
      <a href="feedback.html" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:text-white">
        <i class="fas fa-edit mr-3"></i>피드백 편집
      </a>
      <a href="#" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:text-white" onclick="logout()">
        <i class="fas fa-sign-out-alt mr-3"></i>로그아웃
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="ml-64 min-h-screen bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="px-6 py-4">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold text-gray-800">대시보드</h2>
          <div class="flex items-center space-x-4">
            <div class="text-sm text-gray-600" id="currentDateTime"></div>
            <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
              <i class="fas fa-sync-alt mr-1"></i>새로고침
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Dashboard Content -->
    <div class="p-6">
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
              <i class="fas fa-users text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">총 참여자</p>
              <p class="text-2xl font-semibold text-gray-900" id="totalParticipants">0</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
              <i class="fas fa-check-circle text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">완료</p>
              <p class="text-2xl font-semibold text-gray-900" id="completedTests">0</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
              <i class="fas fa-clock text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">진행 중</p>
              <p class="text-2xl font-semibold text-gray-900" id="inProgressTests">0</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-600">
              <i class="fas fa-exclamation-triangle text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">미시작</p>
              <p class="text-2xl font-semibold text-gray-900" id="notStartedTests">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions and Recent Activity -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">빠른 작업</h3>
          <div class="space-y-3">
            <a href="participants.html" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-left block">
              <i class="fas fa-user-plus mr-2"></i>새 참여자 등록
            </a>
            <button onclick="sendBulkEmail()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-left">
              <i class="fas fa-envelope mr-2"></i>진단 링크 일괄 발송
            </button>
            <button onclick="exportResults()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg text-left">
              <i class="fas fa-download mr-2"></i>결과 내보내기
            </button>
            <a href="feedback.html" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg text-left block">
              <i class="fas fa-edit mr-2"></i>피드백 편집
            </a>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">최근 활동</h3>
          <div id="recentActivity" class="space-y-3 text-sm">
            <div class="flex items-center text-gray-600">
              <i class="fas fa-info-circle mr-2 text-blue-500"></i>
              <div>
                <div>데이터를 불러오는 중...</div>
                <div class="text-xs text-gray-400">잠시만 기다려주세요</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">진행률 현황</h3>
          <div style="height: 300px;">
            <canvas id="progressChart"></canvas>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">일주일 완료 추이</h3>
          <div style="height: 300px;">
            <canvas id="weeklyChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Recent Participants -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">최근 참여자</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">참여자</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">등록일</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">작업</th>
              </tr>
            </thead>
            <tbody id="recentParticipantsTable" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                  참여자 데이터를 불러오는 중...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 페이지 로드 시 인증 확인 및 초기화
    document.addEventListener('DOMContentLoaded', function() {
      // 인증 확인
      if (!window.AdminAuth) {
        // index.html에서 로드되지 않은 경우 직접 인증 확인
        const savedAdmin = localStorage.getItem('currentAdmin');
        if (!savedAdmin) {
          alert('로그인이 필요합니다.');
          window.location.href = 'index.html';
          return;
        }
        const currentAdmin = JSON.parse(savedAdmin);
        document.getElementById('adminWelcome').textContent = `${currentAdmin.name}님 환영합니다`;
      } else {
        const currentAdmin = AdminAuth.checkAuth();
        if (currentAdmin) {
          document.getElementById('adminWelcome').textContent = `${currentAdmin.name}님 환영합니다`;
        }
      }
      
      // 초기화
      updateDateTime();
      setInterval(updateDateTime, 60000);
      loadDashboardData();
    });

    // 현재 시간 업데이트
    function updateDateTime() {
      const now = new Date();
      const dateTimeString = now.toLocaleString('ko-KR');
      document.getElementById('currentDateTime').textContent = dateTimeString;
    }

    // 로그아웃
    function logout() {
      if (confirm('로그아웃 하시겠습니까?')) {
        localStorage.removeItem('currentAdmin');
        window.location.href = 'index.html';
      }
    }

    // 대시보드 데이터 로드
    function loadDashboardData() {
      // 참여자 데이터 로드
      const participantsData = JSON.parse(localStorage.getItem('participantsData') || '[]');
      const resultsData = JSON.parse(localStorage.getItem('resultsData') || '[]');
      
      // 통계 업데이트
      updateDashboardStats(participantsData, resultsData);
      
      // 최근 활동 업데이트
      updateRecentActivity(participantsData, resultsData);
      
      // 최근 참여자 테이블 업데이트
      updateRecentParticipantsTable(participantsData);
      
      // 차트 생성
      createProgressChart(participantsData, resultsData);
      createWeeklyChart(resultsData);
    }

    // 대시보드 통계 업데이트
    function updateDashboardStats(participantsData, resultsData) {
      const totalParticipants = participantsData.length;
      const completedTests = resultsData.length;
      const inProgressTests = participantsData.filter(p => p.status === 'in-progress').length;
      const notStartedTests = totalParticipants - completedTests - inProgressTests;
      
      document.getElementById('totalParticipants').textContent = totalParticipants;
      document.getElementById('completedTests').textContent = completedTests;
      document.getElementById('inProgressTests').textContent = inProgressTests;
      document.getElementById('notStartedTests').textContent = Math.max(0, notStartedTests);
    }

    // 최근 활동 업데이트
    function updateRecentActivity(participantsData, resultsData) {
      const recentActivityContainer = document.getElementById('recentActivity');
      
      // 최근 5개 활동 생성
      const activities = [];
      
      // 최근 완료된 진단
      resultsData.slice(-3).forEach(result => {
        activities.push({
          type: 'completion',
          text: `${result.participantName || '참여자'}님이 진단을 완료했습니다`,
          time: new Date(result.completedAt || result.testDate).toLocaleString('ko-KR'),
          icon: 'fas fa-check-circle text-green-500'
        });
      });
      
      // 최근 등록된 참여자
      participantsData.slice(-2).forEach(participant => {
        activities.push({
          type: 'registration',
          text: `${participant.name}님이 등록되었습니다`,
          time: new Date(participant.registeredAt).toLocaleString('ko-KR'),
          icon: 'fas fa-user-plus text-blue-500'
        });
      });
      
      // 시간순 정렬
      activities.sort((a, b) => new Date(b.time) - new Date(a.time));
      
      if (activities.length === 0) {
        recentActivityContainer.innerHTML = `
          <div class="flex items-center text-gray-600">
            <i class="fas fa-info-circle mr-2 text-gray-400"></i>
            <div>최근 활동이 없습니다</div>
          </div>
        `;
      } else {
        recentActivityContainer.innerHTML = activities.slice(0, 5).map(activity => `
          <div class="flex items-center text-gray-600">
            <i class="${activity.icon} mr-2"></i>
            <div class="flex-1">
              <div class="text-sm">${activity.text}</div>
              <div class="text-xs text-gray-400">${activity.time}</div>
            </div>
          </div>
        `).join('');
      }
    }

    // 최근 참여자 테이블 업데이트
    function updateRecentParticipantsTable(participantsData) {
      const tableBody = document.getElementById('recentParticipantsTable');
      const recentParticipants = participantsData.slice(-5).reverse();
      
      if (recentParticipants.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-gray-500">
              등록된 참여자가 없습니다
            </td>
          </tr>
        `;
      } else {
        tableBody.innerHTML = recentParticipants.map(participant => `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-8 w-8">
                  <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center">
                    <i class="fas fa-user text-gray-600 text-sm"></i>
                  </div>
                </div>
                <div class="ml-3">
                  <div class="text-sm font-medium text-gray-900">${participant.name}</div>
                  <div class="text-sm text-gray-500">${participant.email}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${new Date(participant.registeredAt).toLocaleDateString('ko-KR')}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadgeClass(participant.status)}">
                ${getStatusText(participant.status)}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <a href="participants.html?id=${participant.participantCode}" class="text-blue-600 hover:text-blue-900">
                관리
              </a>
            </td>
          </tr>
        `).join('');
      }
    }

    // 상태 배지 클래스 반환
    function getStatusBadgeClass(status) {
      switch (status) {
        case 'completed': return 'bg-green-100 text-green-800';
        case 'in-progress': return 'bg-yellow-100 text-yellow-800';
        case 'not-started': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    // 상태 텍스트 반환
    function getStatusText(status) {
      switch (status) {
        case 'completed': return '완료';
        case 'in-progress': return '진행 중';
        case 'not-started': return '미시작';
        default: return '알 수 없음';
      }
    }

    // 진행률 차트 생성
    function createProgressChart(participantsData, resultsData) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      
      const completedCount = resultsData.length;
      const inProgressCount = participantsData.filter(p => p.status === 'in-progress').length;
      const notStartedCount = participantsData.length - completedCount - inProgressCount;
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['완료', '진행 중', '미시작'],
          datasets: [{
            data: [completedCount, inProgressCount, Math.max(0, notStartedCount)],
            backgroundColor: [
              '#10B981', // 완료 - 초록색
              '#F59E0B', // 진행 중 - 노란색
              '#EF4444'  // 미시작 - 빨간색
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // 주간 완료 추이 차트 생성
    function createWeeklyChart(resultsData) {
      const ctx = document.getElementById('weeklyChart').getContext('2d');
      
      // 최근 7일 데이터 생성
      const last7Days = Array.from({length: 7}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - i));
        return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
      });
      
      const dailyCompletions = last7Days.map((_, index) => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - index));
        const dateStr = date.toDateString();
        
        return resultsData.filter(result => {
          const resultDate = new Date(result.completedAt || result.testDate);
          return resultDate.toDateString() === dateStr;
        }).length;
      });
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: last7Days,
          datasets: [{
            label: '완료 수',
            data: dailyCompletions,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // 데이터 새로고침
    function refreshData() {
      loadDashboardData();
      alert('데이터가 새로고침되었습니다.');
    }

    // 일괄 이메일 발송
    function sendBulkEmail() {
      const participantsData = JSON.parse(localStorage.getItem('participantsData') || '[]');
      const pendingParticipants = participantsData.filter(p => p.status === 'not-started');
      
      if (pendingParticipants.length === 0) {
        alert('발송할 대상이 없습니다.');
        return;
      }
      
      if (confirm(`${pendingParticipants.length}명에게 진단 링크를 발송하시겠습니까?`)) {
        // 실제로는 이메일 발송 로직 구현
        alert(`${pendingParticipants.length}명에게 이메일을 발송했습니다.`);
      }
    }

    // 결과 내보내기
    function exportResults() {
      const resultsData = JSON.parse(localStorage.getItem('resultsData') || '[]');
      
      if (resultsData.length === 0) {
        alert('내보낼 결과가 없습니다.');
        return;
      }
      
      // CSV 형태로 내보내기
      const csvContent = convertToCSV(resultsData);
      downloadCSV(csvContent, `leadership_results_${new Date().toISOString().split('T')[0]}.csv`);
    }

    // CSV 변환 함수
    function convertToCSV(data) {
      const headers = ['참여코드', '이름', '완료일', '종합점수', '나르시시즘', '마키아벨리즘', '사이코패시'];
      const rows = data.map(result => [
        result.participantCode || '',
        result.participantName || '',
        result.completedAt || result.testDate || '',
        result.overallScore || result.overall || '',
        result.narcissismScore || result.narcissism || '',
        result.machiavellianismScore || result.machiavellianism || '',
        result.psychopathyScore || result.psychopathy || ''
      ]);
      
      return [headers, ...rows].map(row => 
        row.map(field => `"${field}"`).join(',')
      ).join('\n');
    }

    // CSV 다운로드
    function downloadCSV(csvContent, filename) {
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
